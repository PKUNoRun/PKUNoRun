#!/usr/bin/env python3

import sqlite3
import random,math,time,json


one_circle = [
    [116.31275393507501, 39.9878930992251, 0],
    [116.31275787121162, 39.987877034107946, 0],
    [116.31275499378225, 39.98786189587606, 0],
    [116.31275912029979, 39.98784701244487, 0],
    [116.3127610714635, 39.987824664926045, 0],
    [116.3127603976012, 39.987804762941835, 0],
    [116.31276184834093, 39.987787144745845, 0],
    [116.31276368067158, 39.98777603747929, 0],
    [116.31276686630442, 39.98776934274656, 0],
    [116.3127653331318, 39.987768880061154, 0],
    [116.31276647408548, 39.98775799160118, 0],
    [116.31276315602434, 39.98774493269005, 0],
    [116.31276813425668, 39.98772991073608, 0],
    [116.31277506653812, 39.987715512207046, 0],
    [116.31278109724269, 39.98770314219317, 0],
    [116.31278347039677, 39.98768982577828, 0],
    [116.31278598351472, 39.987673949502565, 0],
    [116.31278738679648, 39.98765858045474, 0],
    [116.31278659949348, 39.987642912365324, 0],
    [116.31279119732803, 39.987630849873696, 0],
    [116.31279453423541, 39.98761561679905, 0],
    [116.3127915662432, 39.98759998099655, 0],
    [116.31279363804076, 39.98758071381584, 0],
    [116.31278450693725, 39.98756041709926, 0],
    [116.31277609673334, 39.987535591453614, 0],
    [116.31277075379246, 39.98751897148007, 0],
    [116.31276895784318, 39.98750061760707, 0],
    [116.3127759598046, 39.98748250905066, 0],
    [116.31278125845758, 39.987465617581016, 0],
    [116.31277870150852, 39.987451632561886, 0],
    [116.31278600502412, 39.9874410248372, 0],
    [116.31279282719777, 39.9874275061571, 0],
    [116.31279345621506, 39.98740945651578, 0],
    [116.31279303302054, 39.98739082501979, 0],
    [116.31279515501922, 39.987372347959145, 0],
    [116.31280638587995, 39.98735661686243, 0],
    [116.31280971109634, 39.98734429214715, 0],
    [116.31281098291439, 39.98733816411084, 0],
    [116.3128146892996, 39.987328980187264, 0],
    [116.31281415695291, 39.9873188888494, 0],
    [116.3128152274772, 39.987305700175064, 0],
    [116.31281480487131, 39.987291758871315, 0],
    [116.31280625603877, 39.98728017352066, 0],
    [116.31279914028434, 39.98726989071813, 0],
    [116.31279763550475, 39.98725615753981, 0],
    [116.31279955757326, 39.9872414802865, 0],
    [116.31280071768423, 39.987223541574366, 0],
    [116.31279886191786, 39.98720762769643, 0],
    [116.31279925074763, 39.98719197773539, 0],
    [116.31280023055213, 39.98717451872911, 0],
    [116.31280442649728, 39.987153885190565, 0],
    [116.3128141336467, 39.98713324124375, 0],
    [116.31282205747979, 39.98711505429452, 0],
    [116.31283002139205, 39.987096837414875, 0],
    [116.31283902772915, 39.98708104244965, 0],
    [116.31285401656504, 39.98706786800837, 0],
    [116.31286219120857, 39.98705202159636, 0],
    [116.31287489494757, 39.987035213033245, 0],
    [116.31289567585517, 39.98702421877757, 0],
    [116.31291656713483, 39.98701432476587, 0],
    [116.31292721692783, 39.98699927270678, 0],
    [116.31294133388099, 39.98698500672295, 0],
    [116.31295544084826, 39.98697098073467, 0],
    [116.31296987843194, 39.986956465305894, 0],
    [116.31298756293319, 39.986944335637624, 0],
    [116.31300356399603, 39.986932083034255, 0],
    [116.3130171101241, 39.986920326174435, 0],
    [116.3130295938678, 39.98690678739229, 0],
    [116.31304433276085, 39.98689763272436, 0],
    [116.31306137633636, 39.98688831207335, 0],
    [116.31307988308626, 39.98688046403966, 0],
    [116.31310514413977, 39.986876767966905, 0],
    [116.3131252945291, 39.98687106290205, 0],
    [116.31314989343322, 39.98686079542388, 0],
    [116.31316921262172, 39.986858889076515, 0],
    [116.31318824087982, 39.986854232114965, 0],
    [116.31320472382409, 39.98684858067278, 0],
    [116.31322391191219, 39.98683984383498, 0],
    [116.31324015508869, 39.9868398522135, 0],
    [116.31325553738787, 39.98685084937632, 0],
    [116.31326993687946, 39.98685242456377, 0],
    [116.31328256329186, 39.98685730683067, 0],
    [116.3132958706661, 39.98686130149626, 0],
    [116.31331211337971, 39.98686584838728, 0],
    [116.3133284972699, 39.98686700716253, 0],
    [116.31335003190297, 39.98687179501637, 0],
    [116.31337257782425, 39.98687527438965, 0],
    [116.31339274854693, 39.986878959501415, 0],
    [116.31341751924421, 39.98688105284868, 0],
    [116.31344985622464, 39.98688637970345, 0],
    [116.31348298485659, 39.98689076796314, 0],
    [116.31350960062774, 39.98691380498138, 0],
    [116.3135304138734, 39.98691564163416, 0],
    [116.31355505524276, 39.98692362508823, 0],
    [116.3135493642188, 39.98693872532481, 0],
    [116.31355701179557, 39.986948919342616, 0],
    [116.3135786881616, 39.98696236795533, 0],
    [116.31359993312934, 39.98697663564893, 0],
    [116.31361304152655, 39.986987749119975, 0],
    [116.3136294768796, 39.98698888846838, 0],
    [116.313638597008, 39.987000234921024, 0],
    [116.31364969172321, 39.987015845011134, 0],
    [116.31365869216137, 39.98703159143593, 0],
    [116.31366501771252, 39.9870521233656, 0],
    [116.31367592201448, 39.987067503116944, 0],
    [116.3136884495793, 39.9870823156945, 0],
    [116.31369944341891, 39.987092495395094, 0],
    [116.31371249107038, 39.98709942856878, 0],
    [116.31372077947601, 39.98711052356355, 0],
    [116.31372379720352, 39.98712274935672, 0],
    [116.31372741594224, 39.98713319613221, 0],
    [116.31373062021486, 39.98714543751821, 0],
    [116.31373530742849, 39.98715684147322, 0],
    [116.31374072828797, 39.98716891849932, 0],
    [116.31373821310485, 39.98717088036862, 0],
    [116.31374020694073, 39.98718520269653, 0],
    [116.31374276796769, 39.98719059255305, 0],
    [116.31374152806258, 39.98720167123558, 0],
    [116.31373815341198, 39.98721986605382, 0],
    [116.31373759866116, 39.987240210643776, 0],
    [116.31373674657915, 39.987253947953, 0],
    [116.31373757790695, 39.987267308201424, 0],
    [116.31373650552925, 39.98728229517504, 0],
    [116.3137352551845, 39.98730003370358, 0],
    [116.31373438129749, 39.9873161093151, 0],
    [116.31373233489251, 39.987331302833134, 0],
    [116.31373148473442, 39.98734397185758, 0],
    [116.31372684686407, 39.987355032943945, 0],
    [116.31372867614293, 39.98736846143683, 0],
    [116.31372581988955, 39.98738174521113, 0],
    [116.31372234853244, 39.98739714448307, 0],
    [116.31371981880004, 39.98741007530724, 0],
    [116.31371471970428, 39.98742102680679, 0],
    [116.31370924039368, 39.98743648782353, 0],
    [116.31370681727756, 39.987451314176745, 0],
    [116.31370542620633, 39.987465552316735, 0],
    [116.31370323360247, 39.9874806890872, 0],
    [116.31369507848854, 39.98749365530914, 0],
    [116.31368898753003, 39.98750596512621, 0],
    [116.31368791697307, 39.98751905378201, 0],
    [116.31368645572826, 39.98753305178962, 0],
    [116.31368613725134, 39.98755042193937, 0],
    [116.31368609926238, 39.987567092552624, 0],
    [116.31368710379168, 39.9875867851179, 0],
    [116.31369126460145, 39.987604903155706, 0],
    [116.31369010384425, 39.98761787164848, 0],
    [116.31368992534006, 39.987632731941524, 0],
    [116.31368799312476, 39.98764669912184, 0],
    [116.31368567032719, 39.987662415688476, 0],
    [116.31368263613605, 39.98767866102895, 0],
    [116.313677617401, 39.98769114273511, 0],
    [116.31367618616046, 39.98770468077708, 0],
    [116.31367515588067, 39.98771931956727, 0],
    [116.31367766299722, 39.98773505460674, 0],
    [116.31367802636711, 39.9877559960986, 0],
    [116.31367888094942, 39.98777856851866, 0],
    [116.31368048674015, 39.98779848214793, 0],
    [116.3136834048798, 39.987815647967096, 0],
    [116.31368815649844, 39.987830546910104, 0],
    [116.31368598396666, 39.987845923726766, 0],
    [116.31368002205734, 39.987848523375185, 0],
    [116.31367324856718, 39.98785179162798, 0],
    [116.31365798603576, 39.987842094464504, 0],
    [116.31365153312511, 39.98784471325526, 0],
    [116.31365591401112, 39.98785986155602, 0],
    [116.31365643714223, 39.98787628314371, 0],
    [116.31365450523597, 39.98789270042596, 0],
    [116.31365165125997, 39.9879076960333, 0],
    [116.31365160328818, 39.98792466664197, 0],
    [116.31365325897104, 39.987942910290194, 0],
    [116.3136526900733, 39.98796102003193, 0],
    [116.31365035745407, 39.98797830664726, 0],
    [116.31364815502813, 39.98799500346691, 0],
    [116.31364897810535, 39.98800608536272, 0],
    [116.31364923042888, 39.988020496393645, 0],
    [116.31364612602336, 39.98803616158964, 0],
    [116.3136409576431, 39.98805389325113, 0],
    [116.31363831432064, 39.98807064930059, 0],
    [116.31363267481314, 39.988087090084, 0],
    [116.31362855827868, 39.98810232348875, 0],
    [116.3136214053586, 39.98811629151884, 0],
    [116.31361160678674, 39.98812844483778, 0],
    [116.31360134745879, 39.98814208741141, 0],
    [116.31358614773005, 39.988153541238596, 0],
    [116.31357816275093, 39.98816463769798, 0],
    [116.31356748225994, 39.98817582943883, 0],
    [116.31355644110234, 39.98818758057239, 0],
    [116.3135489067549, 39.98819630772819, 0],
    [116.31354005955902, 39.98820376253294, 0],
    [116.31353048084452, 39.98821104605047, 0],
    [116.31352172401525, 39.988219921074055, 0],
    [116.31351202533067, 39.98822937447286, 0],
    [116.31349989150551, 39.98823759355809, 0],
    [116.31348547278054, 39.98824402857174, 0],
    [116.31346962125996, 39.9882515311237, 0],
    [116.31345804838773, 39.98825810113155, 0],
    [116.31344029260967, 39.98826266023689, 0],
    [116.31342699643032, 39.98827092730334, 0],
    [116.31341092391861, 39.98827396930074, 0],
    [116.31338511120342, 39.988274764169375, 0],
    [116.31336765599181, 39.98827871379571, 0],
    [116.31335435956849, 39.98828487079056, 0],
    [116.31333840740844, 39.98828855304278, 0],
    [116.3133229363579, 39.98829319617946, 0],
    [116.31330495990132, 39.98829552484524, 0],
    [116.31328748436782, 39.98829699435656, 0],
    [116.31327277475015, 39.9883005187906, 0],
    [116.31325632161486, 39.98830436019424, 0],
    [116.31323765373307, 39.98830637765801, 0],
    [116.31321996746652, 39.988305226712534, 0],
    [116.31319968590219, 39.9883040312372, 0],
    [116.31317955453318, 39.9883018759914, 0],
    [116.31316090602431, 39.98829832328385, 0],
    [116.31314105528394, 39.98829647855288, 0],
    [116.31311710611787, 39.98829404665112, 0],
    [116.31309489028303, 39.98828988771233, 0],
    [116.31307493909844, 39.98829090273932, 0],
    [116.31305221208916, 39.98828852287381, 0],
    [116.31303500595729, 39.98828206251863, 0],
    [116.31301779976667, 39.98827308214679, 0],
    [116.31297235388618, 39.98826678184424, 0],
    [116.31295418575655, 39.98826776981186, 0],
    [116.31293941471178, 39.988260043756456, 0],
    [116.31292610637293, 39.98826011016271, 0],
    [116.3129108038658, 39.988259273061, 0],
    [116.31289662372842, 39.98823907794416, 0],
    [116.31288490853277, 39.98822825709786, 0],
    [116.31287189052634, 39.988216133931834, 0],
    [116.31285834119086, 39.98820199976124, 0],
    [116.31284972191958, 39.98818812418738, 0],
    [116.312843998484, 39.98817380363797, 0],
    [116.31283542915291, 39.98816861809955, 0],
    [116.3128270700995, 39.98814222287895, 0],
    [116.31281712761468, 39.98812412483393, 0],
    [116.31281162454614, 39.98811912464338, 0],
    [116.31280051035351, 39.988103742076, 0],
    [116.31279681098835, 39.98809902503668, 0],
    [116.31279030574696, 39.98808293305849, 0],
    [116.31279174633163, 39.988076847506736, 0],
    [116.31278534105758, 39.98806885562653, 0],
    [116.31276377957242, 39.988041186968256, 0],
    [116.31276666912607, 39.98803448913473, 0],
    [116.31276753905879, 39.988029840050235, 0],
    [116.31276116690342, 39.988017377593526, 0],
    [116.31275740579398, 39.98801334613636, 0],
    [116.31274740399665, 39.987997724195915, 0],
    [116.31275057864153, 39.98797328913101, 0],
    [116.31275122229727, 39.98795957317161, 0],
    [116.31275222229727, 39.98794357317161, 0],
    [116.3127545696661, 39.98792916161092, 0],
]

class Record(object):
    """ 54 跑步记录类
        Attibutes:
            class:
                A_Loop_GPS_JSON     str      54 一圈的 GPS 数据
                Distance_Per_Loop   float    实际上传后的每圈距离
            instance:
                duration            int      总跑步时间/s
                date                str      结束时间（时间戳）
                step                int      总步数
                detail              list     跑步路径 GPS 数据， 1 point/s （一秒一个点）
                distance            float    跑步距离/km
                pace                float    跑步速度/(min/km)
                stride_frequncy     int      步频/(step/min)
    """

    A_Loop_GPS_JSON = "400m.250p.54.pkurunner.json"
    Distance_Per_Loop = 0.45  # 由于引入坐标偏移，最终上传后一圈的距离将大于 0.4 km ，此处用于修正上传值与理论值间的误差

    def __init__(self, distance, pace, stride_frequncy):
        """ 由距离、速度、步频来生成一次跑步记录
            Args:
                distance           float   跑步距离/km
                pace               float   跑步速度/(min/km)
                stride_frequncy    int     步频/(step/min)
        """
        self.duration = 0
        self.date = ""
        self.step = 0
        self.detail = []

        self.distance = distance
        self.pace = pace
        self.stride_frequncy = stride_frequncy

        self.__build()

    def __get_date(self):
        """ 获得时间戳
            格式 "2018-09-27T08:04:50.000Z"
        """
        return time.strftime("%Y-%m-%dT%H:%M:%S.000Z", time.gmtime())

    def __point_delta(self):
        """ 坐标随机偏移量
        """
        return (random.random() - 0.5) * 2 * 0.000015  # 0.000015

    def __pace_delta(self):
        """ 速度随机偏移量
        """
        return (random.random() - 0.5) * 2 * 0.1  # 0.1 min/km

    def __stride_frequncy_delta(self):
        """ 步频随机偏移量
        """
        return int((random.random() - 0.5) * 2 * 15)  # 15 step/min

    def __point_generator(self, points_per_loop):
        """ 生成 detail 路径点序列
        """
        points_num_per_loop = int(
            0.4 * self.pace * 60
        )  # 每圈速度 s/(400m) ，1p/1s 因此每圈秒数等于每圈点数

        if points_num_per_loop > len(points_per_loop):  # 确保 250 个点足够描述一圈
            raise ValueError(
                "'pace' should be more than %.2f (min/km) !"
                % (len(points_per_loop) / 0.4 / 60)
            )

        total_loop = self.distance / 0.4  # 以距离决定循环结束点
        current_loop = 0.0

        while current_loop < total_loop:

            points_num_per_loop = int(
                0.4 * (self.pace + self.__pace_delta()) * 60
            )  # 每圈引入一个速率偏移量
            for i in range(points_num_per_loop):
                idx = math.floor(i / points_num_per_loop * len(points_per_loop))
                point = points_per_loop[idx].copy()  # 一定要调用 copy 否则容易偏移过大
                point[0] += self.__point_delta()
                point[1] += self.__point_delta()
                yield point

                current_loop += 1 / points_num_per_loop
                if current_loop >= total_loop:
                    break

    def __build(self):
        """ 构造记录
        """
        # points_per_loop = json_load(self.A_Loop_GPS_JSON)
        points_per_loop = one_circle

        self.date = self.__get_date()
        self.duration = int(
            self.distance
            * self.Distance_Per_Loop
            / 0.4
            * (self.pace + self.__pace_delta())
            * 60
        )  # 跑步时间/s
        self.step = int(
            (self.stride_frequncy + self.__stride_frequncy_delta()) * self.duration / 60
        )  # 总步数
        self.detail = list(self.__point_generator(points_per_loop))

